{% extends "base.html" %}
{% block content %}
<div id="snackbar"></div>
<div class="text-center g-0 mb-4">
	<div class="row m-2">
		<!-- TOP CARD (competition details/owner controls) -->
		<div class="col-lg-3 col-12 text-center mb-2"style="height:fit-content">
			<div class="card">
				<div class="card-header">
					<h2>{{ competition.theme }}</h2>
					<small class="card-title">Hosted by {{ competition.owner }}</small>
				</div>
				<div class="card-title">
					<div class="row mx-1 my-3">
						<div class="input-group" style="z-index:0">
							<input id="room-url"
									type="text"
									class="form-control"
									value="ID: {{ competition.name }}"
									disabled>
							<button class="btn btn-primary" onclick="copyLink()">Copy</button>
						</div>
					</div>
					<div class="row">
						<p id="num_memes">
							{{ competition.num_memes }} meme{{ competition.num_memes|pluralize }} submitted by {{ competition.num_uploaders }} {{ competition.num_uploaders|pluralize:'person,people' }}
						</p>
					</div>
				</div>
				<div class="card-body">
					<div class="row mx-1">
						<button class="btn btn-light btn-sm d-flex justify-content-center"
								type="button"
								onclick="toggleShowParticipants()">
							Participants &nbsp;<span id="num-participants">({{ competition.num_participants }})</span>
						</button>
						<div class="overflow-auto participants-box p-1" style="max-height: 200px;">
							<ul id="participants" class="list-group">
								{% for part in competition.sorted_participants %}
									<li class="list-group-item" data-participant-id="{{part.id}}">
										<div class="d-flex justify-content-between align-items-center">
											<span style="text-align:center">
												{{ part.name }}
											</span>
											<span style="text-align:end">
												<i id="sleep-{{part.id}}" class="mr-2 bi bi-cup-hot {% if part.active %} hidden {% endif %}"></i>
											</span>
										</div>
									</li>
								{% endfor %}
							</ul>
						</div>
					</div>
					<div class="row text-center">
						{% if request.user == competition.owner %}
							<div class="d-flex justify-content-between mt-3">
								<button id="start-comp-btn"
										class="btn btn-success"
										style="width:100%"
										onclick="startCompetition()"
										{% if competition.started %}disabled{% endif %}>
									{% if competition.started %}
										Competition started
									{% else %}
										Start Competition
									{% endif %}
								</button>
								<button id="cancel-comp-btn"
										class="btn btn-danger"
										onclick="cancelCompetition()"
										{% if not competition.started %}disabled{% endif %}>
									<i class="bi bi-x-square"></i>
								</button>
							</div>
							<p>
								<button id="next-meme-btn"
										class="btn btn-primary mx-auto mt-3 col-6"
										onclick="advanceCompetition()"
										{% if not competition.started or competition.finished %}style="display:none"{% endif %}>
									Next meme
								</button>
							</p>
						{% else %}
							<p class="mt-3" id="waiting-msg">
								{% if competition.finished %}
								Competition has finished
								{% elif competition.started %}
								Competion has started
								{% else %}
								Waiting for {{competition.owner.username}} to start the competition...
								{% endif %}
							</p>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
		<!-- COMPETITION FINISHED (winning memes) -->
		<div id="comp-finished"
				class="col row g-0"
				{% if not competition.finished %}style="display:none"{% endif %}>
			<div class="card">
				<div class="card-header">
					<div class="card-title">
						<h2>Competition Results</h2>
					</div>
					<div class="to-details">
					<a href="{% url 'competition_results' competition.name %}" class="btn btn-sm btn-primary back-btn">Detailed Results</a>
					</div>
				</div>
				<div class="card-body g-0">
					<div class="row results-container justify-content-center">
						<div id="winning-meme" class="col-lg-5 col-12 m-2 meme-item min-height-item">
							<div class="row item-header">
								<h5 class="card-title">{{ top_meme.participant }}</h5>
								<h6 class="card-subtitle">Score: {{ top_meme.score }}</h6>
							</div>
							<div class="row meme-item-body">
								<div class="winning-container">
								{% if competition.finished %}
								<img src="/competition/{{ competition.name }}/memes/{{ top_meme.id }}"
										alt="Meme Image"
										class="card-img-top">
								{% endif %}
								</div>
							</div>
						</div>
						<div class="col-lg-5 col-12 m-2 meme-item min-height-item">
							<div class="item-header row">
								<h5 class="card-title">Honourable Mentions</h5>
							</div>
							<div id="mentions" class="meme-item-body row">
								<strong class="m-0">Gracious Reviewer</strong>
								<span id="highest_score_given" class="mb-3">{{competition.highest_avg_score_given.participant}} gave a {{competition.highest_avg_score_given.score}} average score</span>
								
								<strong class="m-0">Harshest Critic</strong>
								<span id="lowest_score_given" class="mb-3">{{competition.lowest_avg_score_given.participant}} gave a {{competition.lowest_avg_score_given.score}} average score</span>
								
								<strong class="m-0">Consistent Creator</strong>
								<span id="highest_avg_score" class="mb-3">{{competition.highest_avg_score_received.participant}} received a {{competition.highest_avg_score_received.score}} weighted score</span>
								
								<strong class="m-0">Unbiased Observer</strong>
								<span id="avg_own_score" class="mb-3">{{competition.lowest_avg_own_memes.participant}} gave themselves a {{competition.lowest_avg_own_memes.score}} average score</span>
								
								<strong class="m-0">Prolific Producer</strong>
								<span id="most_submitted" class="mb-3">{{competition.highest_memes_submitted.participant}} submitted {{competition.highest_memes_submitted.num_memes}} memes</span>
								
								<strong class="m-0">Rapid Grader</strong>
								<span id="fastest_voter" class="mb-3">{{competition.lowest_avg_vote_time.participant}} averaged {{competition.lowest_avg_vote_time.vote_time}} seconds per vote</span>
								
								<strong class="m-0">Thoughtful Assessor</strong>
								<span id="slowest_voter" class="mb-3">{{competition.highest_avg_vote_time.participant}} averaged {{competition.highest_avg_vote_time.vote_time}} seconds per vote</span>
							</div>
						</div>
						<div class="col-lg-3 col-12 m-2 meme-item">
							<div class="row">
								<h5 class="card-title">Statistics</h5>
							</div>
							<div id="statistics" class="row meme-item-body">
								<p>Average Meme Score: <span id="avg_meme_score">{{competition.avg_meme_score}}</span></p>
								<p>Average Vote Time: <span id="avg_vote_time">{{competition.avg_vote_time}}</span></p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- COMPETITION VOTING (display current meme) -->
		<div id="comp-started" class="col text-center" {% if not competition.started or not competition.current_meme %}style="display:none"{% endif %}>
			<div class="vote-container">
				<div class="card" style="width:100%">
					<div class="card-header">
						<div class="row pt-2">
							<div class="col">
								<h4 id="meme-ctr">
									Meme {{ competition.meme_ctr }}/{{ competition.num_memes }}
								</h4>
							</div>
							<div class="col">					
								<h4>
									Total votes: <span id="num_votes">{{ competition.current_meme.num_votes }}</span>
								</h4>
							</div>
						</div>
						<div class="row">
		
						</div>
						<div class="card-title">
							<div id="emoji"></div>
							<div class="mb-1 row d-flex align-items-center justify-content-center">
								<div id="fill-div"></div>
								<button title="Refresh your emoji choices" onclick="createEmojiBtns()" id="refresh-emojis" class="btn btn-sm btn-dark"><i class="bi bi-arrow-clockwise"></i></button>

								<div id="emoji-container">
									<button class="btn btn-light emoji-button e-btn">&#128514</button>
									<button class="btn btn-light emoji-button e-btn">&#128076</button>
									<button class="btn btn-light emoji-button e-btn">&#128169</button>
								</div>
							</div>
							<div class="row d-flex align-items-center justify-content-center">
								<form id="vote-form">
									<div class="form-check form-check-inline">
										<input class="form-check-input vote-radio"
												type="radio"
												name="vote"
												id="vote-option0"
												value="0">
										<label class="form-check-label vote-label" for="vote-option0">0</label>
									</div>
									<div class="form-check form-check-inline">
										<input class="form-check-input vote-radio"
												type="radio"
												name="vote"
												id="vote-option1"
												value="1">
										<label class="form-check-label vote-label" for="vote-option1">1</label>
									</div>
									<div class="form-check form-check-inline">
										<input class="form-check-input vote-radio"
												type="radio"
												name="vote"
												id="vote-option2"
												value="2">
										<label class="form-check-label vote-label" for="vote-option2">2</label>
									</div>
									<div class="form-check form-check-inline">
										<input class="form-check-input vote-radio"
												type="radio"
												name="vote"
												id="vote-option3"
												value="3">
										<label class="form-check-label vote-label" for="vote-option3">3</label>
									</div>
									<div class="form-check form-check-inline">
										<input class="form-check-input vote-radio"
												type="radio"
												name="vote"
												id="vote-option4"
												value="4">
										<label class="form-check-label vote-label" for="vote-option4">4</label>
									</div>
									<div class="form-check form-check-inline">
										<input class="form-check-input vote-radio"
												type="radio"
												name="vote"
												id="vote-option5"
												value="5">
										<label class="form-check-label vote-label" for="vote-option5">5</label>
									</div>
								</form>
							</div>
						</div>
					</div>
					<div class="g-0 image-zoom">
						<img id="current-meme-image"
								src="/competition/{{ competition.name }}/memes/{{ competition.current_meme.id }}"
								alt="Current Meme"
								class="current-meme" 
								onclick="toggleZoom(event)"
								onmouseleave="zoomOut(event)"
						/>
					</div>
				</div>
			</div>
		</div>
		<!-- COMPETITION WAITING (upload memes, uploaded carousel) -->
		<div id="comp-waiting"
				class="col"
				{% if competition.started or competition.finished %}style="display:none"{% endif %}>
			<div class="card">
				<div class="card-header">
					<h4 class="card-title">Memes</h4>
				</div>
				<div class="row mt-2 mx-2">
					<h5 class="card-title">Upload your memes</h5>
					<form id="upload-form" enctype="multipart/form-data" onchange="submitMeme()">
						{% csrf_token %}
						<div class="mb-3 row g-0">
							<div class="col mb-2">
								<input multiple type="file" name="image" class="form-control" id="image" required />
							</div>
							<input type="hidden" name="participant" value="{{ participant.id }}">
							<input type="hidden" name="competition" value="{{ competition.id }}">
						</div>
					</form>
				</div>
				<small id="your-memes" class="mb-2">You have submitted {{participant.memes.all|length}} meme{{participant.memes.all|pluralize}}</small>
				<div class="card-body">
					<div id="carouselExample"
							class="carousel slide carousel-fade"
							data-bs-ride="carousel"
							data-bs-interval="false">
						<div class="carousel-inner" id="submitted-memes-container">
							{% for meme in participant.memes.all %}
								<div id="meme-{{ meme.id }}"
										class="item carousel-item {% if forloop.first %}active{% endif %}">
									<div class="card image-card">
										<div class="image-container">
											<img src="{% url 'serve_file' competition.name meme.id %}"
													alt="{{ meme.title }}"
													class="square-image d-block" />
											<button type="submit"
													class="btn btn-sm btn-danger delete-button"
													onclick="deleteMeme(this)"
													data-meme-id="{{ meme.id }}">Delete</button>
										</div>
									</div>
									
								</div>
							{% endfor %}
						</div>
						<div id="carousel-controls"
								{% if participant.num_memes == 1 %}style="display:none"{% endif %}>
							<button style="background-color:black"
									class="carousel-control-prev"
									type="button"
									data-bs-target="#carouselExample"
									data-bs-slide="prev">
								<span class="carousel-control-prev-icon" aria-hidden="true"></span>
								<span class="visually-hidden">Previous</span>
							</button>
							<button style="background-color:black"
									class="carousel-control-next"
									type="button"
									data-bs-target="#carouselExample"
									data-bs-slide="next">
								<span class="carousel-control-next-icon" aria-hidden="true"></span>
								<span class="visually-hidden">Next</span>
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- 
	ROFL: 128514
	Confused face: 128533
	Poo: 128169
	OK hand: 128076
	Trophy: 127942	
	Fire: 128293
	Crab: 129408
 -->
<!-- EMOJI STUFF -->
<script>
	// Function to generate a random number
	function getRandomNumber(min, max) {
	return Math.ceil(Math.random() * (max - min) + min);
	}

	// Function to generate a random emoji
	function getRandomEmoji() {
	const randomIndex = Math.floor(Math.random() * emojis.length);
	return emojis[randomIndex];
	}

	// Function to set random movement values
	function setRandomMovement(emojiElement, emojiText) {
		emojiElement.css('display', '');
		var startX = `${50 + getRandomNumber(-30, 30)}%`;
		var startY = `${25 + getRandomNumber(0, 25)}%`;
		var deg = 10;
		var posRotation = `${deg}deg`;
		var negRotation = `${-1*deg}deg`;
		// document.documentElement.style.setProperty('--start-x', startX);
		// document.documentElement.style.setProperty('--start-y', startY);
		document.documentElement.style.setProperty('--neg-rotation', negRotation);
		document.documentElement.style.setProperty('--pos-rotation', posRotation);
		emojiElement.css('top', startY);
		emojiElement.css('left', startX)
		emojiElement.text(emojiText);
	}

	function createEmoji(emojiText) {
    const id = getRandomNumber(1000, 9999);
    const emojiBody = $('#emoji');
    $('<div>', {
        id: id,
        class: 'emoji',
        style: 'display:none'
    }).appendTo('#emoji');

    const emojiElement = $(`#${id}`);
    setRandomMovement(emojiElement, emojiText);

    setTimeout(function() {
        emojiElement.text('');
        emojiElement.css('display', 'none');
        emojiBody.remove(emojiElement);
    }, 1750);
}
</script>
<style>
	#refresh-emojis {
		margin-left:10px;
		flex-basis:fit-content;
		border-radius:50%;

	}
	#emoji-container {
		display:flex;
		flex-direction: row;
		justify-content: center;
		flex-wrap:wrap;
	}
	.emoji-button {
		border-radius:50%;
		width:40px;
		height:40px;
		font-size:20px;
		display:flex;
		justify-content: center;
		align-items: center;
		margin: 15px;
	}
	#fill-div {
		border-radius:30px;
		width: 100px;
		height: 10px;
		background-color: white;
		border: none;
		position: relative;
		overflow: hidden;
	}

	.div-fill::after {
		content:'';
		position: absolute;
		top: 0;
		left: -100%;
		width: 100%;
		height: 100%;
		background-color: white;
		animation: fillAnimation 2s linear forwards;
		pointer-events: none;
	}

	@keyframes fillAnimation {
	0% { left: -100%; }
	100% { left: 0; }
	}

	.emoji {
		z-index:99999;
		position: absolute;
		/* top: var(--start-y);
		left:  var(--start-x); */
		transform: translate(-50%, -50%);
		transform: rotate(var(--neg-rotation));
		font-size: 5rem;
		animation: moveEmoji ease-in 2s;
		animation-duration: 2s;
		animation-name: moveEmoji;
		animation-iteration-count: 1;
		animation-timing-function: ease-in
	}

	@keyframes moveEmoji {
		0% { 
			/* transform: translate(-50%, -50%);  */
			scale: 0.2;
			opacity: 1;
			transform: rotate(var(--neg-rotation));
		}
		25% {
			transform: rotate(var(--pos-rotation));
		}
		50% {
			transform: rotate(var(--neg-rotation));
		}
		75% {
			transform: rotate(var(--pos-rotation));
		}
		100% { 
			/* transform: translate(calc(-50% + var(--move-x)), calc(-50% + var(--move-y)));  */
			opacity: 0;
			scale: 1;
			display: none;
			transform: rotate(var(--neg-rotation));
		}

		
	}
</style>
<!-- ------------------------------------------------------------ -->
<style>
	.image-zoom {
		position: relative;
		display: inline-block;
	  }
	  
	  .image-zoom img {
		cursor: zoom-in;
		transition: transform 0.3s;
	  }
	  
	  .image-zoom.zoom-in img {
		cursor: zoom-out;
		border: 1px solid black;
	  }

	.carousel-fade .carousel-item {
  		opacity: 0;
  		transition: opacity 0.5s ease-in-out;
	}

	.carousel-fade .carousel-item.active {
		opacity: 1;
	}

	.carousel-fade .carousel-item-next.carousel-item-left,
	.carousel-fade .carousel-item-prev.carousel-item-right,
	.carousel-fade .carousel-item-next.carousel-item-right,
	.carousel-fade .carousel-item-prev.carousel-item-left {
		opacity: 0;
	}

	.carousel-fade .carousel-item-next,
	.carousel-fade .carousel-item-prev,
	.carousel-fade .carousel-item.active.carousel-item-left,
	.carousel-fade .carousel-item.active.carousel-item-right {
		transform: translate3d(0, 0, 0);
	}

	.carousel-fade .carousel-control-prev,
	.carousel-fade .carousel-control-next {
		opacity: 0;
		transition: opacity 0.5s ease-in-out;
	}

	.carousel-fade:hover .carousel-control-prev,
	.carousel-fade:hover .carousel-control-next {
		opacity: 1;
	}

</style>
<script>
	var emojiTimeout;
	function toggleZoom(event) {
		var img = event.target;
		var container = img.parentNode;
	  
		if (container.classList.contains("zoom-in")) {
		  zoomOut(event);
		} else {
		  zoomIn(event);
		}
	}
	
	function zoomIn(event) {
		var img = event.target;
		var container = img.parentNode;
	  
		var rect = img.getBoundingClientRect();
		var offsetX = event.clientX - rect.left;
		var offsetY = event.clientY - rect.top;
	  
		var zoomRatio = 2; // Adjust the zoom level as desired
	  
		container.classList.add("zoom-in");
		container.classList.remove("zoom-out");
	  
		img.style.transformOrigin = offsetX + "px " + offsetY + "px";
		img.style.transform = "scale(" + zoomRatio + ")";
	  }
	  
	function zoomOut(event) {
		var img = event.target;
		var container = img.parentNode;
	  
		container.classList.add("zoom-out");
		container.classList.remove("zoom-in");
		img.style.transform = "scale(1)";
	  }
	
	function createEmojiBtns() {
		const emojis = [
			'&#127378', //'🆒'
			'&#128175',//'💯',
			'&#128170',//'💪',
			'&#128169',//'💩',
			'&#128293',//'🔥',
			'&#128514',//'😂',
			'&#128556',//'😬',
			'&#128579',//'🙃',
			'&#129312',//'🤠',
			'&#129321',//'🤩',
			'&#129408',//'🦀',
			'&#129504',//'🧠',
			'&#128079',//'👏',
			'&#128076',//'👌',
			'&#128077',//'👍',
			'&#127942',//'🏆',
			'&#127881',//'🎉',
			'&#127752',//'🌈',
			'&#10067',//'❓',
			'&#9989',//'✅',
			'&#9940',//'⛔',
			'&#9889',//'⚡',
			'&#11088',//'⭐',
		];
		$('#emoji-container').empty()
		const numBtns = 3;
		for(i=0;i<numBtns;i++) {
			var emoji = emojis[Math.floor(Math.random()*emojis.length)];
			const index = emojis.indexOf(emoji);
			if (index > -1) { // only splice array when item is found
				emojis.splice(index, 1); // 2nd parameter means remove one item only
			}
			$('<button>', {
				id: `emoji-${i}`,
				class: 'btn btn-light emoji-button e-btn',
				html: emoji,
				disabled: emojiTimeout ? true : false
			}).appendTo('#emoji-container');
		}
		// the event trigger needs to be repeated after the elements are created
		$(".e-btn").on('click', function() {
			var $this = $(this);
			const emojiText = $this.text();
			sendEmoji(emojiText);
			const fillDiv = $('#fill-div');
			fillDiv.css('background-color', 'black');
			fillDiv.addClass('div-fill');
			$('.emoji-button').attr('disabled', true);

			emojiTimeout = setTimeout(function() {
				fillDiv.removeClass('div-fill');
				$('.emoji-button').attr('disabled', false);
				fillDiv.css('background-color', 'white');
				emojiTimeout = 0;
			}, 2000); // Adjust the cooldown duration as desired
		});
	  }
	$(document).ready(function() {
		// createEmojiBtns();
		// if (Math.random() < 0.10) {
		// 	$('#special-emoji').html('&#129408');
		// }

		$('#carouselExample').on('slide.bs.carousel', function (e) {
			var $e = $(e.relatedTarget);
			var idx = $e.index();
			var itemsPerSlide = 1;
			var totalItems = $('.carousel-item').length;
	
			if (idx >= totalItems - (itemsPerSlide - 1)) {
				var it = itemsPerSlide - (totalItems - idx);
				for (var i = 0; i < it; i++) {
					if (e.direction == "left") {
						$('.carousel-item').eq(i).appendTo('.carousel-inner');
					}
					else {
						$('.carousel-item').eq(0).appendTo('.carousel-inner');
					}
				}
			}
		});
		$(".e-btn").on('click', function() {
			var $this = $(this);
			const emojiText = $this.text();
			sendEmoji(emojiText);
			const fillDiv = $('#fill-div');
			fillDiv.css('background-color', 'black');
			fillDiv.addClass('div-fill');
			$('.emoji-button').attr('disabled', true);

			emojiTimeout = setTimeout(function() {
				fillDiv.removeClass('div-fill');
				$('.emoji-button').attr('disabled', false);
				fillDiv.css('background-color', 'white');
				emojiTimeout = 0;
			}, 2000); // Adjust the cooldown duration as desired
		});
	});

	function toggleShowParticipants() {
		const box = $('.participants-box');
		if(box.hasClass('collapse')) {
			box.removeClass('collapse')
		} else {
			box.addClass('collapse')
		}
	}
	
	var snackbarTimeout;
	var prevColour;
	function showSnackbar(message, colour) {
		var snackbar = $("#snackbar");
		if (snackbarTimeout) {
			clearTimeout(snackbarTimeout);
			snackbarTimeout = null;
			snackbar.removeClass("show");
		}
		if (prevColour !== colour) {
			snackbar.removeClass(`btn-${prevColour}`)
			prevColour = null;
		}
	
		snackbar.text(message);
		snackbar.addClass(`btn-${colour}`)
	
		prevColour = colour;
		snackbar.addClass("show");

		snackbarTimeout = setTimeout(function() {
			snackbar.removeClass("show");
		}, 2900); // Adjust the timeout duration as needed
	}

	const csrfToken = "{{csrf_token}}";

	function copyLink() {
		// Get the text field
		var compLink = "{{ request.get_host }}{% url 'competition' competition.name %}";
		navigator.clipboard.writeText(compLink)
		console.log('copied', compLink)

		// Copy the text inside the text field
		// Alert the copied text
		showSnackbar("Competition URL has been copied", 'primary');
	}

	const ctr_thresh = 100;
	var end = null;
	var timeout = 30;
	var ajaxCtr = 0;

	function getTimeSeconds() {
		var date = new Date();
		return (date.getTime() / 1000);
	}
	function checkAjaxCtr() {
		ajaxCtr++;

		if(ajaxCtr > ctr_thresh) {
			if(!end) {
				alert('You are sending too many requests. Please calm down.')
				end = getTimeSeconds() + timeout;
				return false;
			}
			var current = getTimeSeconds();
			if(current < end) {
				showSnackbar(`You have been timed out, try again in ${Math.ceil(end-current)} seconds`, "danger");
				return false
			} else {
				end = null;
				ajaxCtr = 0;
			}
		}
		return true
	}
	// Start competition via AJAX
	function startCompetition() {
		$.ajax({
			url: "{% url 'start_competition' competition.name %}",
			type: "POST",
			data: {},
			beforeSend: function (xhr) {
				xhr.setRequestHeader("X-CSRFToken", csrfToken);
			},
			success: function (response) {
				// Handle success response
				// Update necessary elements
				$('#start-comp-btn').attr('disabled', true);
				$('#cancel-comp-btn').attr('disabled', false);
				$('#start-comp-btn').text('Competition started');
				$("#next-meme-btn").css('display', 'inline');
			},
			error: function (xhr, status, error) {
				showSnackbar(xhr.responseJSON.detail, 'danger')
			}
		});
	}

	// restart the competition via AJAX
	function cancelCompetition() {
		var cancelCheck = 'Are you sure you want to cancel the competition? This will erase all votes.'
		if(Math.random() < 0.01) {
			cancelCheck = "Go ahead, cancel it. See if I care. I'm gonna delete all your votes if you do"
		}
		if(!confirm(cancelCheck)) {
			return
		}
		$.ajax({
			url: "{% url 'cancel_competition' competition.name %}",
			type: "POST",
			data: {},
			beforeSend: function (xhr) {
				xhr.setRequestHeader("X-CSRFToken", csrfToken);
			},
			success: function (response) {
				// Handle success response
				// Update necessary elements
				$('#start-comp-btn').attr('disabled', false);
				$('#cancel-comp-btn').attr('disabled', true);
				$('#start-comp-btn').text('Start Competition');
				$("#next-meme-btn").css('display', 'none');

			},
			error: function (xhr, status, error) {
				showSnackbar('Unable to cancel competition', 'danger');
			}
		});
	}

	// load next meme via AJAX
	function advanceCompetition() {
		$.ajax({
			url: "{% url 'advance_competition' competition.name %}",
			type: "POST",
			data: {},
			beforeSend: function (xhr) {
				xhr.setRequestHeader("X-CSRFToken", csrfToken);
			},
			success: function (response) {
			},
			error: function (xhr, status, error) {
				showSnackbar('Unable to advance competition', 'danger');
			}
		});
	}

	// Submit meme via AJAX
	function submitMeme() {
		$('#submit-meme-btn').attr('disabled', true);
		$('#submit-meme-btn').text('Submitting');

		var form = document.getElementById("upload-form");
		var formData = new FormData(form);

		$.ajax({
			url: "{% url 'meme_upload' comp_name=competition.name %}",
			type: "POST",
			data: formData,
			processData: false,
			contentType: false,
			success: function (response) {
				// Handle success response
				// Clear the input field
				$('#image').val('');
				// Load submitted memes
				if(Math.random() < 0.01) {
					showSnackbar("lol that's a good one", "success");
				} else {
					showSnackbar('Meme uploaded', 'success');
				}
				memeSubmitted(response);
			},
			error: function (xhr, status, error) {
				if(xhr.status === 403) {
					showSnackbar(xhr.responseJSON.detail, 'danger')
				} else {
					showSnackbar('Error uploading your meme :(', 'danger')
				}
			}
		}).then(() => {
			$('#submit-meme-btn').attr('disabled', false);
			$('#submit-meme-btn').text('Submit');
		});
	}

	// load the submitted meme onto the page
	function memeSubmitted(id_list) {
		var actualLength = 0;
		for(i=0;i<id_list.length;i++) {
			var id = id_list[i];
			var memes = $("#submitted-memes-container").find('.item');
			if(memes.length >= 1) {
				$('#carousel-controls').css('display', 'inline')
			}
			var current = $("#submitted-memes-container").find('.active').first();
			current.removeClass('active');
			element = `
				<div id="meme-${id}" class="item carousel-item active">
					<div class="card image-card">
						<div class="image-container">
							<img src="/competition/{{competition.name}}/memes/${id}" alt="Dank memez yeeeea boii" class="square-image" />
							<button type="submit" class="btn btn-sm btn-danger delete-button" onclick="deleteMeme(this)" data-meme-id="${id}">
								Delete
							</button>
						</div>
					</div>
				</div>
				`
			$('#submitted-memes-container').append(element);
			actualLength = memes.length + 1;
		}

		$('#your-memes').text(`You have submitted ${actualLength} meme${actualLength == 1 ? '':'s'}`);
	}

	// delete meme via AJAX
	function deleteMeme(button) {
		var deleteCheck = 'Are you sure you want to delete that meme?'
		if(Math.random() < 0.01) {
			deleteCheck = "Try uploading the right image next time"
		}
		if(!confirm(deleteCheck)) {
			return
		}

		const memeId = $(button).data('meme-id');
		$.ajax({
			url: `/api/meme/${memeId}`,
			type: "DELETE",
			processData: false,
			contentType: false,
			beforeSend: function (xhr) {
				xhr.setRequestHeader("X-CSRFToken", csrfToken);
			},
			success: function (response) {
				// Load submitted memes
				showSnackbar('Meme deleted', 'success')
				memeDeleted(memeId);
			},
			error: function (xhr, status, error) {
				if(xhr.status === 403) {
					showSnackbar(xhr.responseJSON.detail, 'danger')
				} else {
					showSnackbar('Unable to delete meme', 'danger')
				}
			}
		});
	}

	// remove the delete meme from the page
	function memeDeleted(memeId) {
		var memes = $("#submitted-memes-container").find('.item');
		if(memes.length <= 2) {
			$('#carousel-controls').css('display', 'none')
		}
		const carousel = $('#submitted-memes-container')

		carousel.find(`[id="meme-${memeId}"]`).remove()
		var next = carousel.find('.item').first();
		next.addClass('active');
		var actualLength = memes.length -1;
		$('#your-memes').text(`You have submitted ${actualLength} meme${actualLength == 1 ? '':'s'}`);

	}

	// submit vote via AJAX
	function submitVote() {
		// Get the selected vote option
		var selectedOption = document.querySelector('input[name="vote"]:checked').value;
		// Prepare the data to be sent in the AJAX request
		var formData = new FormData();
		formData.append('vote', selectedOption);
		$.ajax({
			url: `/api/competition/{{competition.name}}/vote`,
			type: "POST",
			data: formData,
			processData: false,
			contentType: false,
			beforeSend: function (xhr) {
				xhr.setRequestHeader("X-CSRFToken", csrfToken);
			},
			success: function (response) {
				if(Math.random() < 0.05 && selectedOption == 0) {
					showSnackbar("Damn that's harsh, even for you...", 'success');
				} else {
					showSnackbar('Vote submitted', 'success')
				}
			},
			error: function (xhr, status, error) {
				if(xhr.status === 403) {
					showSnackbar(xhr.responseJSON.detail, 'danger')
				} else {
					showSnackbar('Unable to submit vote', 'danger')
				}
			}
		});
	}

	function sendEmoji(emojiText) {
		if (checkAjaxCtr()) {

			// send emoji via socket rather than via request
			socket.send(JSON.stringify({
				'command':'send_emoji',
				'message':emojiText
			}));
		}
		// if (checkAjaxCtr()) {
		// 	$.ajax({
		// 		url: `/api/competition/{{competition.name}}/emoji`,
		// 		type: "POST",
		// 		data: {text:emojiText},
		// 		beforeSend: function (xhr) {
		// 			xhr.setRequestHeader("X-CSRFToken", csrfToken);
		// 		},
		// 		success: function (response) {
		// 		},
		// 		error: function (xhr, status, error) {
		// 			showSnackbar(xhr.responseJSON.detail, 'danger')
		// 		}
		// 	});
		// }
	}

	function updateParticipantStatus(participantId, active) {
		const participantLi = $(`li[data-participant-id="${participantId}"]`);
		const sleepIcon = $(`li[data-participant-id="${participantId}"] i`);

		if (sleepIcon.length > 0) {
			if(active) {
				if(!sleepIcon.hasClass('hidden')) {
					sleepIcon.addClass('hidden');
					$('#participants').remove(participantLi);
					$("#participants").prepend(participantLi);
				}
			} else {
				if(sleepIcon.hasClass('hidden')) {
					sleepIcon.removeClass('hidden');
					$('#participants').remove(participantLi);
					$("#participants").append(participantLi);
				}
			}
		}
	}
	
	$('#upload-form').on('submit', function (event) {
		event.preventDefault();
		submitMeme();
	});

	$('input[type=radio][name=vote]').on('change', function() {
		const memeId = $(this).data('meme-id');
		submitVote(memeId);
	});


	// ------------------------ WEB SOCKETS -----------------------------------	
	// Open websocket connection
	var socket = null; // Declare the socket variable outside the function
	function connectWebSocket() {
		socket = new WebSocket(

			"{{websocket_scheme}}://" +
			window.location.host +
			"/{{websocket_scheme}}/competitions/{{ competition.name }}/participant/{{ participant.id }}/"
		);

		socket.onopen = function (event) {
			console.log("Websocket connection opened.");
		};

		// Handle received messages
		socket.onmessage = function (event) {
			var message = JSON.parse(event.data);
			console.log(message);
			
			var command = message.command;
			if (command === "user_joined") {
				var participantName = message.data.name;
				const participantId = message.data.id;
				const numParticipants = message.data.num_participants;
				var participantList = $("#participants");
				
				if (
					participantList.find(`li[data-participant-id="${participantId}"]`).length === 0
				) {
					participantList.prepend(`
						<li class='list-group-item' data-participant-id="${participantId}">
							<div class="d-flex justify-content-between align-items-center">
								<span style="text-align:center">
									${participantName}
								</span>
								<span style="text-align:end">
									<i id="sleep-${participantId}" class="mr-2 bi bi-cup-hot {% if part.active %} hidden {% endif %}"></i>
								</span>
							</div>
						</li>
					`);
				}
				$('#num-participants').text(`(${numParticipants})`);

				if(Math.random() < 0.05) {
					showSnackbar(`Oh look, ${participantName} is here!`, 'success')
				} else if (Math.random() < 0.05) {
					showSnackbar(`Look who showed up, it's ${participantName}`, 'success')
				} else if (Math.random() < 0.05) {
					showSnackbar(`A wizard is never late, ${participantName} arrives precisely when they mean to`)
				} else {
					showSnackbar(`${participantName} joined`, 'success');
				}
				updateParticipantStatus(participantId, true)
			} else if (command === "meme_uploaded") {
				const num_uploaders = message.data.num_uploaders;
				const num_memes = message.data.num_memes;
				const text = `${num_memes} meme${num_memes != 1 ? 's':''} submitted by ${num_uploaders} ${num_uploaders != 1 ? 'people':'person'}`
				$("#num_memes").text(text);

			} else if (command === "competition_cancelled") {
				$("#comp-started").css('display', 'none')
				$("#comp-finished").css('display', 'none')
				$("#comp-waiting").css('display', 'inline')
				$("#current-meme-image").attr('src', '')
				$('input[name="vote"]').prop('checked', false);
				$("#num_votes").text('0');
				$("#waiting-msg").text('Waiting for {{competition.owner.username}} to start the competition...');
				showSnackbar('Competition cancelled', 'info');

			} else if (command === "next_meme") {
				const memeId = message.data.id;
				const memeCtr = message.data.ctr;
				const numMemes = message.data.num_memes
				$("#comp-started").css('display', '')
				$("#comp-waiting").css('display', 'none')
				$('input[name="vote"]').prop('checked', false);
				$("#num_votes").text('0');
				$("#current-meme-image").attr('src', `/competition/{{competition.name}}/memes/${memeId}`)
				$("#waiting-msg").text('Competition has started');
				$('#meme-ctr').text(`Meme ${memeCtr}/${numMemes}`);
				showSnackbar(`Time to Vote (${memeCtr}/${numMemes})`, 'success');
			} else if (command === "meme_voted") {
				$("#num_votes").text(message.data)
			} else if (command === "competition_results") {

				$("#comp-started").css('display', 'none')
				$("#comp-waiting").css('display', 'none')
				$("#comp-finished").css('display', '')
				$("#next-meme-btn").css('display', 'none');
				$("#waiting-msg").text('Competition has finished');

				showSnackbar('Competition has finished', 'info')

				const results = message.data;
				if(results) {
					html = `
						<div class="row item-header">
							<h5 class="card-title">${ results.top_meme.participant }</h5>
							<h6 class="card-subtitle">Score: ${ results.top_meme.score }</h6>
						</div>
						<div class="row meme-item-body">
							<div class="winning-container">
								<img src="/competition/{{ competition.name }}/memes/${ results.top_meme.id }"
										alt="Meme Image"
										class="card-img-top">
							</div>
						</div>
					`;
				
					$('#winning-meme').html(html);
					for (const [key, value] of Object.entries(results.statistics)) {
						$(`#${key}`).text(value);
					}
				}
			} else if (command == 'user_active') {
				const id = message.data['id'];
				const active = message.data['active']
				updateParticipantStatus(id,active);
			} else if (command == 'update_emoji') {
				const emoji = message.data;
				createEmoji(emoji)
			} else if (command == 'update_shame') {
				const text = message.data;
				showSnackbar(text, 'danger');
			}
		};

		socket.onclose = function (event) {
			console.log("Websocket connection closed.");
			// Attempt to reconnect after a delay
			setTimeout(connectWebSocket, 2000); // Adjust the delay as needed
		};

		socket.onerror = function (error) {
			console.error("Websocket error:", error);
		};
	}

	
	// Call the connectWebSocket function to establish the initial WebSocket connection
	connectWebSocket();
</script>
{% endblock content %}
