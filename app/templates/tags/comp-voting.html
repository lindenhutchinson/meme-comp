<div id="comp-started" class="col text-center" 
{% if not competition.started or not competition.current_meme%}style="display:none" {% endif %}>
    <div class="vote-container">
        <div class="card shadow" style="width:100%">
            <div class="card-header">
                <div class="card-title">
                    <div class="d-flex align-items-center justify-content-around">
                        <h4 id="meme-ctr">
                            Meme {{ competition.meme_ctr }}/{{ competition.num_memes }}
                        </h4>
                        <div class="d-flex justify-content-center align-items-center">
                            <div id="fill-div"></div>
                            <button title="Refresh your emoji choices" onclick="createEmojiBtns()" id="refresh-emojis"
                                class="btn btn-sm btn-dark"><i class="bi bi-arrow-clockwise"></i></button>

                            <div id="emoji-container">
                                <button class="btn btn-light emoji-button e-btn">&#128514</button>
                                <button class="btn btn-light emoji-button e-btn">&#128076</button>
                                <button class="btn btn-light emoji-button e-btn">&#128169</button>
                            </div>
                        </div>
                        <h4>
                            Total votes: 
                            <span id="num_votes">
                            {% if competition.current_meme %}
                                {{ competition.current_meme.num_votes }}
                            {% endif %}
                            </span>
                        </h4>
                    </div>
                    <div class="d-flex align-items-center justify-content-center">
                        <form id="vote-form">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input vote-radio" type="radio" name="vote" id="vote-option0"
                                    value="0">
                                <label class="form-check-label vote-label" for="vote-option0">0</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input vote-radio" type="radio" name="vote" id="vote-option1"
                                    value="1">
                                <label class="form-check-label vote-label" for="vote-option1">1</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input vote-radio" type="radio" name="vote" id="vote-option2"
                                    value="2">
                                <label class="form-check-label vote-label" for="vote-option2">2</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input vote-radio" type="radio" name="vote" id="vote-option3"
                                    value="3">
                                <label class="form-check-label vote-label" for="vote-option3">3</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input vote-radio" type="radio" name="vote" id="vote-option4"
                                    value="4">
                                <label class="form-check-label vote-label" for="vote-option4">4</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input vote-radio" type="radio" name="vote" id="vote-option5"
                                    value="5">
                                <label class="form-check-label vote-label" for="vote-option5">5</label>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="g-0 image-zoom">
                <div id="emoji"></div>

                <img id="current-meme-image" {% if competition.started and competition.current_meme %}
                    src="/competition/{{ competition.name }}/memes/{{ competition.current_meme.id }}" {% endif %}
                    alt="Current Meme" class="current-meme" onclick="toggleZoom(event)" onmouseleave="zoomOut(event)" />

            </div>
        </div>
    </div>
</div>

<script>
    const EMOJI_LIST = [
        '&#127378', //'ğŸ†’'
        '&#128175',//'ğŸ’¯',
        '&#128170',//'ğŸ’ª',
        '&#128169',//'ğŸ’©',
        '&#128293',//'ğŸ”¥',
        '&#128514',//'ğŸ˜‚',
        '&#128556',//'ğŸ˜¬',
        '&#128579',//'ğŸ™ƒ',
        '&#129312',//'ğŸ¤ ',
        '&#129321',//'ğŸ¤©',
        '&#129408',//'ğŸ¦€',
        '&#129504',//'ğŸ§ ',
        '&#127942',//'ğŸ†',
        '&#127881',//'ğŸ‰',
        '&#127752',//'ğŸŒˆ',
        '&#10067',//'â“',
        '&#9989',//'âœ…',
        '&#9940',//'â›”',
        '&#9889',//'âš¡',
        '&#11088',//'â­',
        '&#9749',//â˜•
        '&#127383',//ğŸ†—
        '&#127775',//ğŸŒŸ
        '&#128512', //ğŸ˜€
        '&#128526', //ğŸ˜
        '&#128540', //ğŸ˜œ
        '&#128514', //ğŸ˜‚
        '&#128525', //ğŸ˜
        '&#129395', //ğŸ¥³
        '&#129302', //ğŸ¤–
        '&#128640', //ğŸš€
        '&#128188', //ğŸ’¼
        '&#129488', //ğŸ§
        '&#127752', //ğŸŒˆ
        '&#128293', //ğŸ”¥
        '&#128175', //ğŸ’¯
        '&#127881', //ğŸ‰
        '&#128642', //ğŸš‚
        '&#127775', //ğŸŒŸ
        '&#127829', //ğŸ•
        '&#127928', //ğŸ¸
        '&#127849', //ğŸ©
        '&#128125', //ğŸ‘½
        '&#127880', //ğŸˆ
        '&#127866', //ğŸº
        '&#127829', //ğŸ•
        '&#129311', //ğŸ¤Ÿ
        '&#129304', //ğŸ¤˜
        '&#128378', //ğŸ•º
        '&#127875', //ğŸƒ
        '&#127754', //ğŸŒŠ
        '&#128269', //ğŸ”
        '&#127922', //ğŸ²
        '&#128197', //ğŸ“…
        '&#128161', //ğŸ’¡
        '&#128678', //ğŸš¦
        '&#127756', //ğŸŒŒ
        '&#127808', //ğŸ€
        '&#127984', //ğŸ°
        '&#127843', //ğŸ£
        '&#127828', //ğŸ”
        '&#127908', //ğŸ¤
        '&#127929', //ğŸ¹
        '&#127917', //ğŸ­
        '&#127790', //ğŸŒ®
        '&#128641', //ğŸš
        '&#128760', //ğŸ›¸
        '&#127905', //ğŸ¡
        '&#127906', //ğŸ¢
        '&#128640', //ğŸš€
        '&#128641', //ğŸš
        '&#127943', //ğŸ‡
        '&#127797', //ğŸŒµ
        '&#128511', //ğŸ—¿
        '&#127920', //ğŸ°
        '&#128218', //ğŸ“š
        '&#128225', //ğŸ“¡
        '&#128302', //ğŸ”®
        '&#127942', //ğŸ†
        '&#127865', //ğŸ¹
        '&#127867', //ğŸ»
        '&#127863', //ğŸ·
        '&#127853', //ğŸ­
        '&#127852', //ğŸ¬
        '&#128641', //ğŸš
        '&#127922', //ğŸ²
        '&#127918', //ğŸ®
        '&#127923', //ğŸ³
        '&#127955', //ğŸ“
        '&#127919', //ğŸ¯
        '&#127992', //ğŸ¸
        '&#127921', //ğŸ±
        '&#127912', //ğŸ¨
        '&#127908', //ğŸ¤
        '&#127911', //ğŸ§
        '&#127932', //ğŸ¼
        '&#127928', //ğŸ¸
        '&#129345', //ğŸ¥
        '&#127927', //ğŸ·
        '&#127930', //ğŸº
        '&#127931', //ğŸ»
        '&#127982', //ğŸ®
        '&#128248', //ğŸ“¸
        '&#127909', //ğŸ¥
        '&#128225', //ğŸ“¡
        '&#128250', //ğŸ“º
        '&#128251', //ğŸ“»
        '&#128240', //ğŸ“°
        '&#128200', //ğŸ“ˆ
        '&#128201', //ğŸ“‰
        '&#128273', //ğŸ”‘
        '&#128296', //ğŸ”¨
        '&#128295', //ğŸ”§
        '&#128297', //ğŸ”©
        '&#128279', //ğŸ”—
        '&#128137', //ğŸ’‰
        '&#127993', //ğŸ¹
        '&#128299', //ğŸ”«
        '&#128163', //ğŸ’£
        '&#128298', //ğŸ”ª
        '&#128684', //ğŸš¬
        '&#128138', //ğŸ’Š
        '&#128136', //ğŸ’ˆ
        '&#128176', //ğŸ’°
        '&#128179', //ğŸ’³
        '&#128142', //ğŸ’
        '&#128276', //ğŸ””
        '&#128161', //ğŸ’¡
        '&#128701', //ğŸš½
        '&#128703', //ğŸš¿
        '&#128705', //ğŸ›
        '&#128682', //ğŸšª
        '&#128716', //ğŸ›Œ
        '&#128722', //ğŸ›’
        '&#127873', //ğŸ
        '&#127880', //ğŸˆ
        '&#127872', //ğŸ€
        '&#127882', //ğŸŠ
        '&#127881', //ğŸ‰
        '&#127886', //ğŸ
        '&#127982', //ğŸ®
        '&#128512', //ğŸ˜€
        '&#128515', //ğŸ˜ƒ
        '&#128516', //ğŸ˜„
        '&#128513', //ğŸ˜
        '&#128518', //ğŸ˜†
        '&#128517', //ğŸ˜…
        '&#128514', //ğŸ˜‚
        '&#129315', //ğŸ¤£
        '&#128522', //ğŸ˜Š
        '&#128519', //ğŸ˜‡
        '&#128578', //ğŸ™‚
        '&#128579', //ğŸ™ƒ
        '&#128521', //ğŸ˜‰
        '&#128524', //ğŸ˜Œ
        '&#128525', //ğŸ˜
        '&#129392', //ğŸ¥°
        '&#128536', //ğŸ˜˜
        '&#128535', //ğŸ˜—
        '&#128537', //ğŸ˜™
        '&#128538', //ğŸ˜š
        '&#128523', //ğŸ˜‹
        '&#128539', //ğŸ˜›
        '&#128540', //ğŸ˜œ
        '&#129322', //ğŸ¤ª
        '&#128541', //ğŸ˜
        '&#129297', //ğŸ¤‘
        '&#129303', //ğŸ¤—
        '&#129325', //ğŸ¤­
        '&#129323', //ğŸ¤«
        '&#129300', //ğŸ¤”
        '&#129296', //ğŸ¤
        '&#129320', //ğŸ¤¨
        '&#128528', //ğŸ˜
        '&#128529', //ğŸ˜‘
        '&#128566', //ğŸ˜¶
        '&#128527', //ğŸ˜
        '&#128530', //ğŸ˜’
        '&#128580', //ğŸ™„
        '&#128556', //ğŸ˜¬
        '&#129317', //ğŸ¤¥
        '&#128524', //ğŸ˜Œ
        '&#128532', //ğŸ˜”
        '&#128554', //ğŸ˜ª
        '&#129316', //ğŸ¤¤
        '&#128564', //ğŸ˜´
        '&#128567', //ğŸ˜·
        '&#129298', //ğŸ¤’
        '&#129301', //ğŸ¤•
        '&#129314', //ğŸ¤¢
        '&#129326', //ğŸ¤®
        '&#129319', //ğŸ¤§
        '&#128565', //ğŸ˜µ
        '&#129327', //ğŸ¤¯
        '&#129312', //ğŸ¤ 
        '&#129395', //ğŸ¥³
        '&#128526', //ğŸ˜
        '&#129299', //ğŸ¤“
        '&#129488', //ğŸ§
        '&#128533', //ğŸ˜•
        '&#128543', //ğŸ˜Ÿ
        '&#128577', //ğŸ™
        '&#128558', //ğŸ˜®
        '&#128559', //ğŸ˜¯
        '&#128562', //ğŸ˜²
        '&#128563', //ğŸ˜³
        '&#129402', //ğŸ¥º
        '&#128550', //ğŸ˜¦
        '&#128551', //ğŸ˜§
        '&#128552', //ğŸ˜¨
        '&#128560', //ğŸ˜°
        '&#128549', //ğŸ˜¥
        '&#128546', //ğŸ˜¢
        '&#128557', //ğŸ˜­
        '&#128561', //ğŸ˜±
        '&#128534', //ğŸ˜–
        '&#128547', //ğŸ˜£
        '&#128542', //ğŸ˜
        '&#128531', //ğŸ˜“
        '&#128553', //ğŸ˜©
        '&#128555', //ğŸ˜«
        '&#128548', //ğŸ˜¤
        '&#128545', //ğŸ˜¡
        '&#128544', //ğŸ˜ 
        '&#129324', //ğŸ¤¬
        '&#128520', //ğŸ˜ˆ
        '&#128127', //ğŸ‘¿
        '&#128128', //ğŸ’€
        '&#128169', //ğŸ’©
        '&#129313', //ğŸ¤¡
        '&#128121', //ğŸ‘¹
        '&#128122', //ğŸ‘º
        '&#128123', //ğŸ‘»
        '&#128125', //ğŸ‘½
        '&#128126', //ğŸ‘¾
        '&#129302', //ğŸ¤–
        '&#128570', //ğŸ˜º
        '&#128568', //ğŸ˜¸
        '&#128569', //ğŸ˜¹
        '&#128571', //ğŸ˜»
        '&#128572', //ğŸ˜¼
        '&#128573', //ğŸ˜½
        '&#128576', //ğŸ™€
        '&#128575', //ğŸ˜¿
        '&#128574', //ğŸ˜¾
        '&#128080', //ğŸ‘
        '&#128588', //ğŸ™Œ
        '&#128079', //ğŸ‘
        '&#128591', //ğŸ™
        '&#129330', //ğŸ¤²
        '&#129309', //ğŸ¤
        '&#129310', //ğŸ¤
        '&#129311', //ğŸ¤Ÿ
        '&#129304', //ğŸ¤˜
        '&#129305', //ğŸ¤™
        '&#128072', //ğŸ‘ˆ
        '&#128073', //ğŸ‘‰
        '&#128070', //ğŸ‘†
        '&#128405', //ğŸ–•
        '&#128071', //ğŸ‘‡
        '&#128074', //ğŸ‘Š
        '&#129307', //ğŸ¤›
        '&#129308', //ğŸ¤œ
        '&#128076', //ğŸ‘Œ
        '&#128077', //ğŸ‘
        '&#128078', //ğŸ‘
        '&#9994', //âœŠ
        '&#128074', //ğŸ‘Š
    ];

    var emojiTimeout;
    $(document).ready(function () {
        $(".e-btn").on('click', function () {
            var $this = $(this);
            const emojiText = $this.text();
            sendEmoji(emojiText);
            const fillDiv = $('#fill-div');
            fillDiv.css('background-color', 'black');
            fillDiv.addClass('div-fill');
            $('.emoji-button').attr('disabled', true);

            emojiTimeout = setTimeout(function () {
                fillDiv.removeClass('div-fill');
                $('.emoji-button').attr('disabled', false);
                fillDiv.css('background-color', 'white');
                emojiTimeout = 0;
            }, 2000); // Adjust the cooldown duration as desired
        });
        $('input[type=radio][name=vote]').on('change', function () {
            const memeId = $(this).data('meme-id');
            submitVote(memeId);
        });
    });



    // submit vote via AJAX
    function submitVote() {
        // Get the selected vote option
        var selectedOption = document.querySelector('input[name="vote"]:checked').value;
        // Prepare the data to be sent in the AJAX request
        var formData = new FormData();
        formData.append('vote', selectedOption);
        $.ajax({
            url: `/api/competition/{{competition.name}}/vote`,
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            beforeSend: function (xhr) {
                xhr.setRequestHeader("X-CSRFToken", csrfToken);
            },
            success: function (response) {
                if (Math.random() < 0.05 && selectedOption == 0) {
                    showSnackbar("Damn that's harsh, even for you...", 'success');
                } else {
                    showSnackbar('Vote submitted', 'success')
                }
                $('#readyup-btn').prop('disabled', true);
            },
            error: function (xhr, status, error) {
                if (xhr.status === 403) {
                    showSnackbar(xhr.responseJSON.detail, 'danger')
                } else {
                    showSnackbar('Unable to submit vote', 'danger')
                }
            }
        });
    }

    const EMOJI_TIMEOUT_THRESHOLD = 10;
    const REFRESH_TIMEOUT_SECONDS = 2;
    const TIMEOUT_SECONDS = 30;
    var end = null;
    var last = null;
    var emojiCtr = 0;

    function getTimeSeconds() {
        var date = new Date();
        return (date.getTime() / 1000);
    }
    function checkEmojiCtr() {
        emojiCtr++;
        var current = getTimeSeconds();
        if (emojiCtr > EMOJI_TIMEOUT_THRESHOLD) {
            if (!end) {
                alert('You are sending too many requests. Please calm down.')
                end = getTimeSeconds() + TIMEOUT_SECONDS;
                return false;
            }
            if (current < end) {
                showSnackbar(`You have been timed out, try again in ${Math.ceil(end - current)} seconds`, "danger");
                return false
            } else {
                end = null;
                emojiCtr = 0;
            }
        } else if (current - last >= REFRESH_TIMEOUT_SECONDS) {
            console.log('ğŸ’©');
            // reset the emoji ctr so normal users dont get timed out
            emojiCtr = 0;
        }
        last = getTimeSeconds();

        return true
    }

    function sendEmoji(emojiText) {
        if (checkEmojiCtr()) {
            // send emoji via socket rather than via request
            socket.send(JSON.stringify({
                'command': 'send_emoji',
                'message': emojiText
            }));
        }
    }

    function toggleZoom(event) {
        var img = event.target;
        var container = img.parentNode;

        if (container.classList.contains("zoom-in")) {
            zoomOut(event);
        } else {
            zoomIn(event);
        }
    }

    function zoomIn(event) {
        var img = event.target;
        var container = img.parentNode;

        var rect = img.getBoundingClientRect();
        var offsetX = event.clientX - rect.left;
        var offsetY = event.clientY - rect.top;

        var zoomRatio = 2; // Adjust the zoom level as desired

        container.classList.add("zoom-in");
        container.classList.remove("zoom-out");

        img.style.transformOrigin = offsetX + "px " + offsetY + "px";
        img.style.transform = "scale(" + zoomRatio + ")";
    }

    function zoomOut(event) {
        var img = event.target;
        var container = img.parentNode;

        container.classList.add("zoom-out");
        container.classList.remove("zoom-in");
        img.style.transform = "scale(1)";
    }

    function getRandomEmoji() {
        var randomCodePoint = Math.floor(Math.random() * (0x1F601 - 0x1F64F  + 1)) + 0x1F64F;
        return `&#${randomCodePoint};`;
    }
    function createEmojiBtns() {
        $('#emoji-container').empty()
        const numBtns = 3;
        // get a copy of the emoji constant to avoid modifying it
        const emojiList = EMOJI_LIST.slice(0);
        for (i = 0; i < numBtns; i++) {
            var emoji = emojiList[Math.floor(Math.random() * emojiList.length)];
            const index = emojiList.indexOf(emoji);
            if (index > -1) { // only splice array when item is found
                emojiList.splice(index, 1); // 2nd parameter means remove one item only
            }
            if (Math.random() < 0.1) {
                emoji = getRandomEmoji();
            }

            $('<button>', {
                id: `emoji-${i}`,
                class: 'btn btn-light emoji-button e-btn',
                html: emoji,
                disabled: emojiTimeout ? true : false
            }).appendTo('#emoji-container');
        }
        // the event trigger needs to be repeated after the elements are created
        $(".e-btn").on('click', function () {
            var $this = $(this);
            const emojiText = $this.text();
            sendEmoji(emojiText);
            const fillDiv = $('#fill-div');
            fillDiv.css('background-color', 'black');
            fillDiv.addClass('div-fill');
            $('.emoji-button').attr('disabled', true);

            emojiTimeout = setTimeout(function () {
                fillDiv.removeClass('div-fill');
                $('.emoji-button').attr('disabled', false);
                fillDiv.css('background-color', 'white');
                emojiTimeout = 0;
            }, 2000); // Adjust the cooldown duration as desired
        });
    }
    /**
     * Generates a random number within the specified range.
     *
     * @param {number} min - The minimum value of the range (inclusive).
     * @param {number} max - The maximum value of the range (inclusive).
     * @returns {number} A random number within the specified range.
     */
    function getRandomNumber(min, max) {
        return Math.ceil(Math.random() * (max - min) + min);
    }

    /**
     * Sets random movement values for an emoji element.
     *
     * @param {jQuery} emojiElement - The jQuery object representing the emoji element.
     * @param {string} emojiText - The text to be displayed in the emoji element.
     */
    function setRandomMovement(emojiElement, emojiText) {
        emojiElement.css('display', '');
        var startX = `${50 + getRandomNumber(-30, 30)}%`;
        var startY = `${25 + getRandomNumber(0, 25)}%`;
        var deg = 10;
        var posRotation = `${deg}deg`;
        var negRotation = `${-1*deg}deg`;
        // document.documentElement.style.setProperty('--start-x', startX);
        // document.documentElement.style.setProperty('--start-y', startY);
        document.documentElement.style.setProperty('--neg-rotation', negRotation);
        document.documentElement.style.setProperty('--pos-rotation', posRotation);
        emojiElement.css('top', startY);
        emojiElement.css('left', startX)
        emojiElement.text(emojiText);
    }

    /**
     * Creates an emoji element with random movement and removes it after a certain time.
     *
     * @param {string} emojiText - The text to be displayed in the emoji element.
     */
    function createEmoji(emojiText) {
        const id = getRandomNumber(1000, 9999);
        const emojiBody = $('#emoji');
        const emojiElement = $('<div>', {
                id: id,
                class: 'emoji',
                style: 'display:none'
        }).appendTo('#emoji');

        setRandomMovement(emojiElement, emojiText);

        setTimeout(function() {
            emojiElement.text('');
            emojiElement.css('display', 'none');
            emojiBody.remove(emojiElement);
        }, 1750);
    }
</script>

<style>
	#refresh-emojis {
		margin-left:10px;
		flex-basis:fit-content;
		border-radius:50%;

	}
	#emoji-container {
		display:flex;
		flex-direction: row;
		justify-content: center;
		flex-wrap:wrap;
	}
	.emoji-button {
		border-radius:50%;
		width:40px;
		height:40px;
		font-size:20px;
		display:flex;
		justify-content: center;
		align-items: center;
		margin: 15px;
	}
	#fill-div {
		border-radius:30px;
		width: 100px;
		height: 10px;
		background-color: white;
		border: none;
		position: relative;
		overflow: hidden;
	}

	.div-fill::after {
		content:'';
		position: absolute;
		top: 0;
		left: -100%;
		width: 100%;
		height: 100%;
		background-color: white;
		animation: fillAnimation 2s linear forwards;
		pointer-events: none;
	}

	@keyframes fillAnimation {
	0% { left: -100%; }
	100% { left: 0; }
	}

	.emoji {
		z-index:99999;
		position: absolute;
		/* top: var(--start-y);
		left:  var(--start-x); */
		transform: translate(-50%, -50%);
		transform: rotate(var(--neg-rotation));
		font-size: 5rem;
		animation: moveEmoji ease-in 2s;
		animation-duration: 2s;
		animation-name: moveEmoji;
		animation-iteration-count: 1;
		animation-timing-function: ease-in
	}

	@keyframes moveEmoji {
		0% { 
			/* transform: translate(-50%, -50%);  */
			scale: 0.2;
			opacity: 1;
			transform: rotate(var(--neg-rotation));
		}
		25% {
			transform: rotate(var(--pos-rotation));
		}
		50% {
			transform: rotate(var(--neg-rotation));
		}
		75% {
			transform: rotate(var(--pos-rotation));
		}
		100% { 
			/* transform: translate(calc(-50% + var(--move-x)), calc(-50% + var(--move-y)));  */
			opacity: 0;
			scale: 1;
			display: none;
			transform: rotate(var(--neg-rotation));
		}
	}
</style>